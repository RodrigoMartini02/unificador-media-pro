const { app, BrowserWindow, ipcMain, dialog, shell } = require('electron');
const path = require('path');
const fs = require('fs');

// CORRIGIDO - Importar servidor corretamente
let MediaServer;
try {
    MediaServer = require('./server.js');
} catch (error) {
    console.error('‚ùå Erro ao importar server.js:', error.message);
    process.exit(1);
}

class MediaUnifierApp {
    constructor() {
        this.mainWindow = null;
        this.server = null;
        this.serverPort = 3005; // MUDAN√áA: Porta diferente
        this.isDev = process.env.NODE_ENV === 'development';
    }

    async init() {
        console.log('üöÄ Iniciando Unificador de M√≠dia Pro...');
        
        await app.whenReady();
        
        // Iniciar servidor primeiro
        await this.startServer();
        
        // Criar janela
        this.createWindow();
        
        this.setupAppEvents();
        this.setupIPC();
    }

    async startServer() {
        try {
            console.log(`üåê Iniciando servidor na porta ${this.serverPort}...`);
            this.server = new MediaServer(this.serverPort);
            await this.server.start();
            console.log(`‚úÖ Servidor iniciado na porta ${this.serverPort}`);
        } catch (error) {
            console.error('‚ùå Erro ao iniciar servidor:', error);
            
            // Tentar porta alternativa
            if (error.code === 'EADDRINUSE') {
                console.log('üîÑ Tentando porta alternativa...');
                this.serverPort = await this.findAvailablePort();
                try {
                    this.server = new MediaServer(this.serverPort);
                    await this.server.start();
                    console.log(`‚úÖ Servidor iniciado na porta ${this.serverPort}`);
                    return;
                } catch (retryError) {
                    console.error('‚ùå Erro na segunda tentativa:', retryError);
                }
            }
            
            dialog.showErrorBox('Erro do Sistema', 'Falha ao iniciar o servidor interno: ' + error.message);
            app.quit();
        }
    }

    async findAvailablePort() {
        const net = require('net');
        
        for (let port = 3005; port <= 3020; port++) {
            if (await this.isPortAvailable(port)) {
                return port;
            }
        }
        throw new Error('Nenhuma porta dispon√≠vel encontrada');
    }

    isPortAvailable(port) {
        return new Promise((resolve) => {
            const server = net.createServer();
            server.listen(port, () => {
                server.close(() => resolve(true));
            });
            server.on('error', () => resolve(false));
        });
    }

    createWindow() {
        console.log('üñ•Ô∏è Criando janela principal...');
        
        this.mainWindow = new BrowserWindow({
            width: 1200,
            height: 800,
            minWidth: 900,
            minHeight: 600,
            webPreferences: {
                nodeIntegration: false,
                contextIsolation: true,
                preload: path.join(__dirname, 'preload.js'),
                webSecurity: true
            },
            titleBarStyle: 'default',
            center: true,
            show: false,
            title: 'Unificador de M√≠dia Pro',
            icon: this.getAppIcon()
        });

        // Remover menu
        this.mainWindow.setMenuBarVisibility(false);

        // Aguardar servidor estar pronto antes de carregar
        setTimeout(() => {
            console.log(`üåê Carregando interface em http://localhost:${this.serverPort}`);
            this.mainWindow.loadURL(`http://localhost:${this.serverPort}`)
                .then(() => {
                    console.log('‚úÖ Interface carregada com sucesso');
                })
                .catch(err => {
                    console.error('‚ùå Erro ao carregar interface:', err);
                    dialog.showErrorBox('Erro', 'Falha ao carregar a interface: ' + err.message);
                });
        }, 3000); // Aguardar 3 segundos para garantir

        // Mostrar quando carregada
        this.mainWindow.once('ready-to-show', () => {
            console.log('‚úÖ Janela pronta - exibindo aplica√ß√£o');
            this.mainWindow.show();
            if (this.isDev) {
                this.mainWindow.webContents.openDevTools();
            }
        });

        this.mainWindow.on('closed', () => {
            console.log('üî¥ Janela fechada pelo usu√°rio');
            this.mainWindow = null;
            if (this.server) {
                this.server.stop();
            }
            app.quit();
        });

        // Debug detalhado
        this.mainWindow.webContents.on('did-fail-load', (event, errorCode, errorDescription, validatedURL) => {
            console.error('‚ùå Falha ao carregar:', {
                errorCode,
                errorDescription,
                url: validatedURL
            });
        });

        this.mainWindow.webContents.on('did-finish-load', () => {
            console.log('‚úÖ Conte√∫do da p√°gina carregado completamente');
        });

        this.mainWindow.webContents.on('dom-ready', () => {
            console.log('‚úÖ DOM da p√°gina est√° pronto');
        });
    }

    getAppIcon() {
        // Tentar encontrar √≠cone
        const iconPaths = [
            path.join(__dirname, 'assets', 'icon.png'),
            path.join(__dirname, 'assets', 'icon.ico')
        ];

        for (const iconPath of iconPaths) {
            if (fs.existsSync(iconPath)) {
                return iconPath;
            }
        }
        return null; // Usar √≠cone padr√£o
    }

    setupAppEvents() {
        app.on('window-all-closed', () => {
            console.log('üî¥ Todas as janelas fechadas');
            if (this.server) {
                this.server.stop();
            }
            app.quit();
        });

        app.on('activate', () => {
            if (BrowserWindow.getAllWindows().length === 0) {
                console.log('üîÑ Reativando aplica√ß√£o...');
                this.createWindow();
            }
        });

        app.on('before-quit', () => {
            console.log('üî¥ Preparando para encerrar...');
            if (this.server) {
                this.server.stop();
            }
        });
    }

    setupIPC() {
        ipcMain.handle('select-files', async () => {
            try {
                const result = await dialog.showOpenDialog(this.mainWindow, {
                    properties: ['openFile', 'multiSelections'],
                    filters: [
                        { name: 'Arquivos de M√≠dia', extensions: ['mp4', 'avi', 'mov', 'mkv', 'mp3', 'wav', 'flac', 'm4a'] },
                        { name: 'V√≠deos', extensions: ['mp4', 'avi', 'mov', 'mkv', 'webm'] },
                        { name: '√Åudios', extensions: ['mp3', 'wav', 'flac', 'm4a', 'aac', 'ogg'] }
                    ]
                });
                return result;
            } catch (error) {
                console.error('‚ùå Erro ao selecionar arquivos:', error);
                return { canceled: true };
            }
        });

        ipcMain.handle('select-output-folder', async () => {
            try {
                const result = await dialog.showOpenDialog(this.mainWindow, {
                    properties: ['openDirectory']
                });
                return result;
            } catch (error) {
                console.error('‚ùå Erro ao selecionar pasta:', error);
                return { canceled: true };
            }
        });

        ipcMain.handle('show-in-folder', (event, filePath) => {
            try {
                shell.showItemInFolder(filePath);
                return { success: true };
            } catch (error) {
                console.error('‚ùå Erro ao abrir pasta:', error);
                return { success: false, error: error.message };
            }
        });
    }
}

// Configura√ß√µes do Electron
app.commandLine.appendSwitch('--disable-web-security');
app.setName('Unificador de M√≠dia Pro');

// Tratamento de erros n√£o capturadas
process.on('uncaughtException', (error) => {
    console.error('‚ùå Erro n√£o capturado:', error);
    dialog.showErrorBox('Erro Fatal', error.message);
    app.quit();
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('‚ùå Promise rejeitada:', reason);
});

// Prevenir m√∫ltiplas inst√¢ncias
const gotTheLock = app.requestSingleInstanceLock();

if (!gotTheLock) {
    console.log('‚ùå Aplica√ß√£o j√° est√° rodando - fechando esta inst√¢ncia');
    app.quit();
} else {
    // Inicializar aplica√ß√£o
    const mediaApp = new MediaUnifierApp();
    
    app.on('second-instance', () => {
        // Focar na janela existente se tentar abrir segunda inst√¢ncia
        console.log('üîÑ Segunda inst√¢ncia detectada - focando janela existente');
        if (mediaApp.mainWindow) {
            if (mediaApp.mainWindow.isMinimized()) {
                mediaApp.mainWindow.restore();
            }
            mediaApp.mainWindow.focus();
        }
    });

    mediaApp.init().catch(error => {
        console.error('‚ùå Erro fatal na inicializa√ß√£o:', error);
        dialog.showErrorBox('Erro Fatal', 'Falha ao inicializar: ' + error.message);
        app.quit();
    });
}